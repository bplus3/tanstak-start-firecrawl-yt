/* eslint-disable @typescript-eslint/no-unnecessary-condition */
import { ScriptOnce } from '@tanstack/react-router'
import {
    createContext,
    use,
    useCallback,
    useEffect,
    useMemo,
    useState,
} from 'react'

type Theme = 'dark' | 'light' | 'system'
const MEDIA = '(prefers-color-scheme: dark)'

type ThemeProviderProps = {
    children: React.ReactNode
    defaultTheme?: Theme
    storageKey?: string
}

type ThemeProviderState = {
    theme: Theme
    setTheme: (theme: Theme) => void
}

const initialState: ThemeProviderState = {
    theme: 'system',
    setTheme: () => null,
}

const ThemeProviderContext = createContext<ThemeProviderState>(initialState)

export function ThemeProvider({
    children,
    defaultTheme = 'system',
    storageKey = 'theme',
    ...props
}: ThemeProviderProps) {
    const [theme, setTheme] = useState<Theme>(
        () =>
            (typeof window !== 'undefined'
                ? (localStorage.getItem(storageKey) as Theme)
                : null) || defaultTheme,
    )

    const handleMediaQuery = useCallback(
        (e: MediaQueryListEvent | MediaQueryList) => {
        if (theme !== 'system') return 
        const root = window.document.documentElement
        const targetTheme = e.matches ? 'dark' : 'light'
        if (!root.classList.contains(targetTheme)) {
            root.classList.remove('light', 'dark')
            root.classList.add(targetTheme)
        }
    }, [theme])

    useEffect(() => {   
        const mediaQuery = window.matchMedia(MEDIA)
        mediaQuery.addEventListener('change', handleMediaQuery)
        return () => {
            mediaQuery.removeEventListener('change', handleMediaQuery)
        }
    }, [handleMediaQuery])

    const value = useMemo(() => ({ theme, setTheme }), [theme])

    return (
        <ThemeProviderContext.Provider value={value} {...props}>
            <ScriptOnce>
                {`
                document.documentElement.classList.toggle(
                    'dark',
                    localStorage.getItem('${storageKey}') === 'dark' ||
                    (!localStorage.getItem('${storageKey}') &&
                    window.matchMedia('(prefers-color-scheme: dark)').matches)
                );
                document.documentElement.classList.toggle(
                    'light',
                    localStorage.getItem('${storageKey}') === 'light' ||
                    (!localStorage.getItem('${storageKey}') &&
                    !window.matchMedia('(prefers-color-scheme: dark)').matches)
                );
                `}
            </ScriptOnce>
            {children}
        </ThemeProviderContext.Provider>
    )
}

export const useTheme = () => {
    const context = use(ThemeProviderContext)
    if (context === undefined) {
        throw new Error('useTheme must be used within a ThemeProvider')
    }
    return context  
}